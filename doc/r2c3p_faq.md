# fmls_r2c3p 常见问题

目录:

- r2c3p 和 MQTT 协议的对比 ?

- r2c3p 的内存占用 ?

## r2c3p 和 MQTT 协议的对比 ?

参考资料: <https://mqtt.org/>

1. MQTT 协议使用发布/订阅模型, 中心服务器 (broker) 同时连接很多 (百万个)
   终端设备 (client).

   r2c3p 是点对点通信的消息发送协议, 只有收发消息的功能, 没有发布/订阅等功能.
   r2c3p 仅用于 r1 (网关设备) 与其直连的 r2 (低资源设备) 之间.

2. MQTT 协议基于 TCP/IP, 可用于广域网传输, 可选 TLS 加密传输, 复杂度相对较高.

   r2c3p 基于 UART (串口) / USB 传输, 仅用于短距离局域网 (r1 和 r2 直连),
   明文传输不加密, 复杂度很低 (功能更简单).

   所以 r2c3p 可用于资源更少的设备 (比如单片机 ch32v003),
   这些设备甚至没有足够的硬件资源去实现 TCP/IP, 也就不能支持 MQTT.

3. r2c3p 仅提供相当于 MQTT QoS 0 (最多一次, r2c3p 静默消息), MQTT QoS 1
   (最少一次, r2c3p 请求响应消息) 的功能, 不提供 MQTT QoS 2 (有且仅有一次)
   的功能.

4. MQTT 协议中的终端设备 (client) 是主动的一方, 中心服务器 (broker)
   是被动的一方. 终端设备需要主动去连接服务器.

   r2c3p 则上位机 (r1) 是主动的一方, 终端设备 (r2 MCU) 是被动的一方. r1 主动探测
   r2 设备是否在线. 因为 r2 设备硬件资源很少, 强大的 r1 应该做更多事情.

## r2c3p 的内存占用 ?

目前 `fmls_r2c3p` 在单片机 (MCU) 的实现, 大约需要占用 2.7KB ~ 7KB 的 flash 空间,
以及 136 ~ 220 字节的 RAM 空间.

栗子如下:

### r2c3p 实际内存占用 (优化后)

- r2c3p 实现: `libfmlsm::r2c3p_low`

- 程序: `sled 0.1.0` (2023-08-07)

- target: `rv32ec` (`riscv32ec-unknown-none-elf`)

- MCU: ch32v003 (2KB SRAM (2048 字节), 16KB flash (16384 字节))

- 编译命令: `cargo +rv32e build --release`

内存占用表: (2023-08-07)

| libfmlsm feature |   RAM 字节 | flash 字节 | 备注 |
| :--------------- | ---------: | ---------: | :--- |
| (无)             | 12 (0.59%) | 750 (4.6%) | (1)  |
|                  | 136 (6.7%) | 2206 (14%) |      |
| `r2c3p-crc16`    | 136 (6.7%) | 3504 (22%) |      |
| `r2c3p-crc32`    | 200 (9.8%) | 5190 (32%) |      |

注: (接收缓冲区为 64 字节)

- (1) 关闭 `sled` 的 `r2c3p` feature (完全不使用 r2c3p)

### r2c3p 实际内存占用 (优化前)

- r2c3p 实现: `libfmlsm::r2c3p_util`

- 程序: `sled 0.1.0` (2023-08-06)

- target: `rv32ec` (`riscv32ec-unknown-none-elf`)

- MCU: ch32v003 (2KB SRAM (2048 字节), 16KB flash (16384 字节))

- 编译命令: `cargo +rv32e build --release`

内存占用表: (2023-08-06)

| libfmlsm feature                    |   RAM 字节 |  flash 字节 | 备注 |
| :---------------------------------- | ---------: | ----------: | :--- |
| (无)                                | 16 (0.79%) |  796 (4.9%) | (1)  |
|                                     | 156 (7.7%) |  2294 (15%) |      |
| `r2c3p-crc16`                       | 168 (8.3%) |  4268 (27%) |      |
| `r2c3p-crc32`                       | 200 (9.8%) |  6514 (40%) |      |
| `r2c3p-crc32`, `r2c3p-c`            | 200 (9.8%) |  6876 (42%) |      |
| `r2c3p-crc32`, `r2c3p-i`            |  236 (12%) |  9144 (56%) |      |
| `r2c3p-crc32`, `r2c3p-i`, `r2c3p-t` |  236 (12%) |  9144 (56%) |      |
| `r2c3p-s`                           |  260 (13%) | 11536 (71%) |      |
| `r2c3p-full`                        |  260 (13%) | 12014 (74%) |      |
| `r2c3p-crc16`, `r2c3p-i`, `r2c3p-t` | 172 (8.4%) |  6234 (39%) | (2)  |
| `r2c3p-crc32`, `r2c3p-t`            | 200 (9.8%) |  6876 (42%) | (3)  |

注: (接收缓冲区为 64 字节)

- (1) 关闭 `sled` 的 `r2c3p` feature (完全不使用 r2c3p)

- (2) 接收缓冲区为 32 字节. 关闭 `crc32` 功能节省了 2910 字节 (17%) 的 flash
  空间.

- (3) 关闭 `r2c3p-i` 功能节省了 2268 字节 (13%) 的 flash 空间.

单个功能对 flash 的占用增量:

| 功能              | 描述                          | flash 字节增量 | 备注 |
| :---------------- | :---------------------------- | -------------: | :--- |
| `r2c3p`           | r2c3p 协议最小支持            |    1498 (9.2%) |      |
| `r2c3p-crc16`     | crc16 计算                    |     1974 (13%) |      |
| **`r2c3p-crc32`** | **crc32 计算**                | **2246 (14%)** | *    |
| `r2c3p-c`         | 对 `c`, `C` 消息的支持 (配置) |     362 (2.3%) |      |
| **`r2c3p-i`**     | **对 `I` 配置项的支持**       | **2268 (14%)** | *    |
| `r2c3p-t`         | 对 `t`, `T` 配置项的支持      |              0 |      |
| **`r2c3p-cc`**    | **传输质量计数器**            | **2392 (15%)** | *    |
| `r2c3p-full`      | `r2c3p-s` 其余的全部功能      |     478 (3.0%) |      |

注: 加粗的表示对 flash 空间的占用显著.

查看内存占用的方法:

```sh
> cd target/riscv32ec-unknown-none-elf/release
> llvm-objdump -h sled
```

其中 `Size` 列为对应节的字节大小 (16 进制).

- 占用 flash 空间的节: `.text`, `.rodata`, `.data`

- 占用 RAM (内存) 空间的节: `.data`, `.bss`

---

TODO
