# fmls_r2c3p 常见问题

目录:

- r2c3p 和 MQTT 协议的对比 ?

- r2c3p 的内存占用 ?

## r2c3p 和 MQTT 协议的对比 ?

参考资料: <https://mqtt.org/>

1. MQTT 协议使用发布/订阅模型, 中心服务器 (broker) 同时连接很多 (百万个)
   终端设备 (client).

   r2c3p 是点对点通信的消息发送协议, 只有收发消息的功能, 没有发布/订阅等功能.
   r2c3p 仅用于 r1 (网关设备) 与其直连的 r2 (低资源设备) 之间.

2. MQTT 协议基于 TCP/IP, 可用于广域网传输, 可选 TLS 加密传输, 复杂度相对较高.

   r2c3p 基于 UART (串口) / USB 传输, 仅用于短距离局域网 (r1 和 r2 直连),
   明文传输不加密, 复杂度很低 (功能更简单).

   所以 r2c3p 可用于资源更少的设备 (比如单片机 ch32v003),
   这些设备甚至没有足够的硬件资源去实现 TCP/IP, 也就不能支持 MQTT.

3. r2c3p 仅提供相当于 MQTT QoS 0 (最多一次, r2c3p 静默消息), MQTT QoS 1
   (最少一次, r2c3p 请求响应消息) 的功能, 不提供 MQTT QoS 2 (有且仅有一次)
   的功能.

4. MQTT 协议中的终端设备 (client) 是主动的一方, 中心服务器 (broker)
   是被动的一方. 终端设备需要主动去连接服务器.

   r2c3p 则上位机 (r1) 是主动的一方, 终端设备 (r2 MCU) 是被动的一方. r1 主动探测
   r2 设备是否在线. 因为 r2 设备硬件资源很少, 强大的 r1 应该做更多事情.

### r2c3p 的内存占用 ?

最小内存占用理论分析 (MCU RAM):

- 消息接收缓冲区: 8 字节 (最小)

- crc 接收缓冲区: 2 字节 (crc16)

- crc 发送缓冲区: 2 字节 (crc16)

以上共计: 12 字节 (MCU 最小需求)

- 消息接收缓冲区: 64 字节 (普通)

- crc 接收缓冲区: 4 字节 (crc32/crc16)

- crc 发送缓冲区: 6 字节 (crc32 + crc16)

- 传输质量计数器: 20 字节 (4 x 5: cT, cR, cRd, cTB, cRB)

- 协议参数配置项: 2 字节 (O, On)

- 上位机标记配置项: 8 字节 (I)

以上共计: 104 字节 (MCU 普通需求)

2KB MCU RAM 内存占用率 (ch32v003):

- 12 字节 (8 字节接收缓冲区): 0.6%

- 36 字节 (32 字节接收缓冲区): 1.8%

- 104 字节 (64 字节接收缓冲区): 5.1%

---

TODO
